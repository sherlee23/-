<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”‹å‘³æ´¾è®¢è´­ç³»ç»Ÿ</title>
    <!-- Icons and theme colors -->
    <link rel="icon" type="image/jpeg" href="fengwei/icon3.jpg">
    <meta name="theme-color" content="#d10000">
    <link rel="apple-touch-icon" href="https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/icon-512x512.png">
    <!-- External libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      /* Animations used throughout the app */
      @keyframes slide-in-down { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      .animate-slide-in-down { animation: slide-in-down 0.3s ease-out forwards; }
      @keyframes slide-in-right { from { transform: translateX(100%); } to { transform: translateX(0); } }
      .animate-slide-in-right { animation: slide-in-right 0.3s ease-out forwards; }
      @keyframes fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
      .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>
    <!-- Main application script -->
    <script type="text/babel">
      const { useState, useEffect, useCallback, useMemo, useRef } = React;

      // --- Supabase configuration & constants ---
      const SUPABASE_URL = 'https://edfnhhthztskuuosuasw.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZm5oaHRoenRza3V1b3N1YXN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5OTYxMTYsImV4cCI6MjA2NTU3MjExNn0.O3g2gjvsWagmWgmzoeJA8mPampvLYJr-KgqVwXsKoAo';
      const WHATSAPP_NUMBER = '60162327792';
      const ADMIN_PASSWORD = 'fengweipaiadmin';
      const SELF_PICKUP_ADDRESS = '667, Jalan 24, Taman Perindustrian Ehsan Jaya, Kepong, 52100, Kuala Lumpur.';
      const PRODUCT_IMAGE_BASE_URL = 'https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/';

      // Initialise Supabase client
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // çŠ¶æ€é€‰é¡¹ï¼Œç”¨äºåå°æ˜¾ç¤ºä¸é€‰æ‹©
      const statusOptions = {
        pending: { label: 'å¾…å¤„ç†', color: 'bg-yellow-200 text-yellow-800' },
        'ready for pick up': { label: 'å¾…è‡ªå–', color: 'bg-blue-200 text-blue-800' },
        delivered: { label: 'å·²å‘è´§', color: 'bg-indigo-200 text-indigo-800' },
        completed: { label: 'å·²å®Œæˆ', color: 'bg-green-200 text-green-800' },
        cancelled: { label: 'å·²å–æ¶ˆ', color: 'bg-red-200 text-red-800' }
      };
      const getStatusStyle = (status) => {
        return statusOptions[status]?.color || 'bg-gray-200 text-gray-800';
      };

      /*
       * -----------------------------------------------------------------------------
       * å·¥å…·å‡½æ•°
       *  1. buildOrderMessage(order): æ ¹æ®è®¢å•å¯¹è±¡ç”Ÿæˆ WhatsApp æ¶ˆæ¯æ–‡æœ¬ã€‚
       *  2. copyTextUniversal(text): å…¼å®¹æ€§å¥½çš„æ–‡æœ¬å¤åˆ¶å‡½æ•°ã€‚
       */
      function buildOrderMessage(order) {
        try {
          let msg = `ğŸ›ï¸ *é”‹å‘³æ´¾æ–°è®¢å• #${order.order_id}*\n\n`;
          msg += 'ğŸ‘¤ *å®¢æˆ·ä¿¡æ¯*\n';
          msg += `ğŸ“› å§“å: ${order.name}\n`;
          msg += `ğŸ“± ç”µè¯: ${order.phone}\n`;
          msg += `ğŸšš å–è´§æ–¹å¼: ${order.delivery_method === 'self-pickup' ? 'è‡ªå–' : 'Lalamoveé€è´§'}\n`;
          if (order.delivery_method === 'self-pickup') {
            msg += `ğŸ“ è‡ªå–åœ°å€: ${SELF_PICKUP_ADDRESS}\n`;
            msg += 'â° å–è´§æ—¶é—´: å¦è¡Œé€šçŸ¥\n';
            msg += `ğŸ“ è”ç»œå·ç : ${WHATSAPP_NUMBER.replace(/^60/, '0')}\n`;
          } else {
            if (order.address) {
              msg += `ğŸ“ é…é€åœ°å€: ${order.address}\n`;
            }
          }
          msg += '\nğŸ›’ *è®¢å•æ˜ç»†*\n';
          if (Array.isArray(order.order_items)) {
            order.order_items.forEach(item => {
              let emoji = item.emoji || '';
              if (!emoji) {
                const n = item.product || item.name || '';
                if (n.includes('çƒ¤è‚ ')) emoji = 'ğŸŒ­';
                else if (n.includes('è™¾')) emoji = 'ğŸ¦';
                else if (n.includes('æŠ«è¨')) emoji = 'ğŸ•';
                else if (n.includes('æ±¤åŒ…')) emoji = 'ğŸ¥Ÿ';
                else if (n.includes('é…¥é¥¼')) emoji = 'ğŸ¥®';
                else if (n.includes('é¸¡æ’') || n.includes('é¸¡ç¿…')) emoji = 'ğŸ—';
                else emoji = 'â–«ï¸';
              }
              const typeLabel = item.is_unlimited ? ' (é¢„è´­)' : ' (ç°è´§)';
              msg += `${emoji} ${item.product || item.name}${typeLabel} Ã— ${item.quantity} = RM${(item.quantity * item.price).toFixed(2)}\n`;
            });
          }
          msg += `\nğŸ’° *æ€»é‡‘é¢: RM${Number(order.total_amount).toFixed(2)}*\n`;
          msg += `ğŸ“ *å¤‡æ³¨*: ${order.remarks || 'æ— '}\n`;
          const createdAt = order.created_at ? new Date(order.created_at) : new Date();
          msg += `ğŸ“… *ä¸‹å•æ—¶é—´*: ${createdAt.toLocaleString('zh-CN')}`;
          return msg;
        } catch (e) {
          console.error('[buildOrderMessage] error:', e, order);
          return 'è®¢å•ä¿¡æ¯ç”Ÿæˆå¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚';
        }
      }

      async function copyTextUniversal(text) {
        // ç°ä»£ Clipboard API
        try {
          if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
            await navigator.clipboard.writeText(text);
            return true;
          }
        } catch (e) {
          // ignore and fallback
        }
        // å›é€€æ–¹æ¡ˆ
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.setAttribute('readonly', '');
          ta.style.position = 'fixed';
          ta.style.top = '-10000px';
          document.body.appendChild(ta);
          ta.select();
          ta.setSelectionRange(0, ta.value.length);
          const ok = document.execCommand('copy');
          document.body.removeChild(ta);
          return ok;
        } catch (e) {
          console.error('[copyTextUniversal] fallback error:', e);
          return false;
        }
      }

      // Toast ç»„ä»¶ï¼Œç”¨äºæ˜¾ç¤ºä¸´æ—¶æ¶ˆæ¯
      const Toast = ({ message, type, onDismiss }) => {
        const typeClasses = {
          success: 'text-green-500',
          danger: 'text-red-500',
          warning: 'text-yellow-500'
        };
        const icons = {
          success: <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd"></path></svg>,
          danger: <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd"></path></svg>,
          warning: <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M8.257 3.099c.636-1.214 2.852-1.214 3.488 0l6.114 11.638c.636 1.214-.474 2.763-1.744 2.763H3.887c-1.27 0-2.38-1.549-1.744-2.763L8.257 3.099zM10 6a1 1 0 011 1v4a1 1 0 11-2 0V7a1 1 0 011-1zm-1 8a1 1 0 102 0 1 1 0 00-2 0z" clipRule="evenodd"></path></svg>
        };
        // è‡ªåŠ¨3ç§’åæ¶ˆå¤±
        useEffect(() => {
          const timer = setTimeout(onDismiss, 3000);
          return () => clearTimeout(timer);
        }, [onDismiss]);
        return (
          <div className="animate-slide-in-down flex items-center w-full max-w-xs p-4 space-x-4 bg-white rounded-lg shadow-lg">
            <div className={`flex-shrink-0 ${typeClasses[type]}`}>{icons[type]}</div>
            <div className="pl-2 text-sm font-normal">{message}</div>
          </div>
        );
      };

      // åŠ è½½ä¸­æŒ‡ç¤ºå™¨
      const LoadingSpinner = ({ text }) => (
        <div className="text-center">
          <svg className="mx-auto h-12 w-12 text-red-600 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          {text && <p className="mt-2 text-lg font-semibold text-gray-700">{text}</p>}
        </div>
      );

      // å•†å“å¡ç‰‡ç»„ä»¶
      const ProductCard = ({ product, onAdd }) => {
        const isOutOfStock = !product.is_unlimited && product.stock !== Infinity && product.stock <= 0;
        const productTypeLabel = product.is_unlimited ? '(é¢„è´­)' : '(ç°è´§)';
        return (
          <div className={`bg-white rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 flex flex-col overflow-hidden ${isOutOfStock ? 'opacity-60 bg-gray-100' : ''}`}>
            <div className="w-full h-52 bg-gray-200 flex items-center justify-center overflow-hidden">
              <img src={product.image} alt={product.name} className="w-full h-full object-contain" onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/400x400/cccccc/ffffff?text=Image+Error'; }} />
            </div>
            <div className="p-5 flex flex-col flex-grow">
              <h3 className="text-lg font-bold text-gray-800">{product.emoji} {product.name} <span className="text-sm font-normal text-gray-500">{productTypeLabel}</span></h3>
              <p className="text-sm text-gray-500 mb-3">åº“å­˜: {product.is_unlimited ? 'å……è¶³' : product.stock}</p>
              <div className="mt-auto flex justify-between items-center">
                <p className="text-xl font-extrabold text-red-600">RM{product.price.toFixed(2)}</p>
                <button onClick={() => onAdd(product)} disabled={isOutOfStock} className="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-2">
                  <i className="fas fa-cart-plus"></i>
                  æ·»åŠ 
                </button>
              </div>
            </div>
          </div>
        );
      };

      // è´­ç‰©è½¦æŠ½å±‰
      const CartDrawer = ({ cart, onClose, updateQty, removeItem, onCheckout }) => {
        const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        return (
          <div className="fixed inset-0 z-50 flex justify-end items-stretch">
            <div className="absolute inset-0 bg-black bg-opacity-50" onClick={onClose}></div>
            <div className="relative bg-white w-full max-w-md h-full overflow-y-auto shadow-lg animate-slide-in-right flex flex-col">
              <div className="p-5 flex justify-between items-center border-b">
                <h2 className="text-lg font-bold">è´­ç‰©è½¦</h2>
                <button onClick={onClose} className="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
              </div>
              <div className="p-5 space-y-4 flex-1 overflow-y-auto">
                {cart.length === 0 ? (
                  <p className="text-center text-gray-500">è´­ç‰©è½¦ä¸ºç©º</p>
                ) : (
                  cart.map(item => (
                    <div key={item.id} className="flex justify-between items-center">
                      <div>
                        <p className="font-semibold">{item.name}</p>
                        <p className="text-sm text-gray-500">RM{item.price.toFixed(2)}</p>
                      </div>
                      <div className="flex items-center">
                        <button onClick={() => updateQty(item.id, item.quantity - 1)} disabled={item.quantity <= 1} className="w-7 h-7 rounded-md bg-gray-200 text-gray-800 hover:bg-gray-300 transition-colors active:scale-90">-</button>
                        <span className="px-3">{item.quantity}</span>
                        <button onClick={() => updateQty(item.id, item.quantity + 1)} disabled={!item.is_unlimited && item.quantity >= item.stock} className="w-7 h-7 rounded-md bg-gray-200 text-gray-800 hover:bg-gray-300 transition-colors active:scale-90">+</button>
                      </div>
                      <button onClick={() => removeItem(item.id)} className="text-gray-400 hover:text-red-500 transition-colors ml-2">
                        <i className="fas fa-trash-alt"></i>
                      </button>
                    </div>
                  ))
                )}
              </div>
              <div className="p-5 border-t">
                <div className="flex justify-between items-center mb-3">
                  <span className="font-semibold text-gray-800">æ€»è®¡:</span>
                  <span className="font-extrabold text-red-600 text-2xl">RM{total.toFixed(2)}</span>
                </div>
                <button onClick={onCheckout} disabled={cart.length === 0} className="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-red-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                  <i className="fa fa-credit-card"></i>
                  ç«‹å³ç»“è´¦
                </button>
              </div>
            </div>
          </div>
        );
      };

      // ç»“è´¦/æ”¯ä»˜æ¨¡æ€æ¡†
      const CheckoutModal = ({ cart, total, onClose, onConfirm }) => {
        const [formData, setFormData] = useState({ name: '', phone: '', delivery: '', remarks: '', paymentMethod: '', address: '' });
        const [paymentProof, setPaymentProof] = useState(null);
        const [errors, setErrors] = useState({});
        const [isShippingPayment, setIsShippingPayment] = useState(false);
        // åˆ¤æ–­æ˜¯å¦ä¸ºè¿è´¹æ”¯ä»˜
        useEffect(() => {
          try {
            const params = new URLSearchParams(window.location.search);
            if (params.get('order_id')) {
              setIsShippingPayment(true);
            }
          } catch (e) {
            // ignore
          }
        }, []);
        // æ ¡éªŒè¡¨å•
        const validate = () => {
          const newErrors = {};
          if (isShippingPayment) {
            if (!paymentProof) newErrors.paymentProof = 'è¯·ä¸Šä¼ æ”¯ä»˜å‡­è¯';
            if (!formData.remarks) newErrors.remarks = 'è¯·å¡«å†™é…é€èµ„æ–™';
          } else {
            if (!formData.name) newErrors.name = 'è¯·è¾“å…¥å§“å';
            if (!formData.phone) newErrors.phone = 'è¯·è¾“å…¥ç”µè¯';
            if (!formData.delivery) newErrors.delivery = 'è¯·é€‰æ‹©å–è´§æ–¹å¼';
            if (formData.delivery === 'lalamove' && !formData.address) newErrors.address = 'è¯·è¾“å…¥é…é€åœ°å€';
            if (!formData.paymentMethod) newErrors.paymentMethod = 'è¯·é€‰æ‹©ä»˜æ¬¾æ–¹å¼';
            if (formData.paymentMethod === 'online' && !paymentProof) newErrors.paymentProof = 'è¯·ä¸Šä¼ æ”¯ä»˜å‡­è¯';
          }
          setErrors(newErrors);
          return Object.keys(newErrors).length === 0;
        };
        const handleChange = (e) => {
          setFormData({ ...formData, [e.target.name]: e.target.value });
        };
        const handleFileChange = (e) => {
          const file = e.target.files[0];
          if (file) {
            setPaymentProof(file);
          }
        };
        const handleSubmit = (e) => {
          e.preventDefault();
          if (!validate()) return;
          onConfirm(formData, paymentProof, isShippingPayment);
        };
        return (
          <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col animate-fade-in">
              <div className="flex justify-between items-center p-5 border-b">
                <h2 className="text-xl font-bold">{isShippingPayment ? 'æ”¯ä»˜è¿è´¹' : 'å¡«å†™è®¢å•ä¿¡æ¯'}</h2>
                <button onClick={onClose} className="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
              </div>
              <form onSubmit={handleSubmit} className="flex-grow overflow-y-auto p-6 space-y-6">
                {isShippingPayment ? (
                  <>
                    <div className="p-4 bg-blue-50 border-l-4 border-blue-400 text-blue-700 mb-4">
                      <h4 className="font-bold">è¯·ä¸Šä¼ è¿è´¹æ”¯ä»˜å‡­è¯ï¼Œå¹¶å¡«å†™é…é€èµ„æ–™</h4>
                    </div>
                    <div>
                      <label className="font-semibold">ä¸Šä¼ è½¬è´¦å‡­è¯ *</label>
                      <input type="file" onChange={handleFileChange} accept="image/*,.pdf" className="mt-1 w-full p-2 border rounded" />
                      {errors.paymentProof && <p className="text-red-500 text-xs mt-1">{errors.paymentProof}</p>}
                    </div>
                    <div>
                      <label className="font-semibold">é…é€èµ„æ–™ *</label>
                      <textarea name="remarks" value={formData.remarks} onChange={handleChange} rows="3" className="w-full mt-1 p-2 border rounded"></textarea>
                      {errors.remarks && <p className="text-red-500 text-xs mt-1">{errors.remarks}</p>}
                    </div>
                  </>
                ) : (
                  <>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                        <label className="font-semibold">å§“å *</label>
                        <input type="text" name="name" value={formData.name} onChange={handleChange} className={`w-full mt-1 p-2 border rounded ${errors.name ? 'border-red-500' : 'border-gray-300'}`} />
                        {errors.name && <p className="text-red-500 text-xs mt-1">{errors.name}</p>}
                      </div>
                      <div>
                        <label className="font-semibold">ç”µè¯ *</label>
                        <input type="tel" name="phone" value={formData.phone} onChange={handleChange} className={`w-full mt-1 p-2 border rounded ${errors.phone ? 'border-red-500' : 'border-gray-300'}`} />
                        {errors.phone && <p className="text-red-500 text-xs mt-1">{errors.phone}</p>}
                      </div>
                      <div>
                        <label className="font-semibold">å–è´§æ–¹å¼ *</label>
                        <select name="delivery" value={formData.delivery} onChange={handleChange} className={`w-full mt-1 p-2 border rounded ${errors.delivery ? 'border-red-500' : 'border-gray-300'}`}> 
                          <option value="">è¯·é€‰æ‹©</option>
                          <option value="self-pickup">è‡ªå–</option>
                          <option value="lalamove">Lalamove</option>
                        </select>
                        {errors.delivery && <p className="text-red-500 text-xs mt-1">{errors.delivery}</p>}
                      </div>
                      {formData.delivery === 'lalamove' && (
                        <div className="md:col-span-2">
                          <label className="font-semibold">é…é€åœ°å€ *</label>
                          <input type="text" name="address" value={formData.address} onChange={handleChange} className={`w-full mt-1 p-2 border rounded ${errors.address ? 'border-red-500' : 'border-gray-300'}`} placeholder="è¯·è¾“å…¥è¯¦ç»†é…é€åœ°å€" />
                          {errors.address && <p className="text-red-500 text-xs mt-1">{errors.address}</p>}
                        </div>
                      )}
                      <div>
                        <label className="font-semibold">å¤‡æ³¨</label>
                        <textarea name="remarks" value={formData.remarks} onChange={handleChange} rows="2" className="w-full mt-1 p-2 border border-gray-300 rounded"></textarea>
                      </div>
                      <div>
                        <label className="font-semibold">ä»˜æ¬¾æ–¹å¼ *</label>
                        <select name="paymentMethod" value={formData.paymentMethod} onChange={handleChange} className={`w-full mt-1 p-2 border rounded ${errors.paymentMethod ? 'border-red-500' : 'border-gray-300'}`}> 
                          <option value="">è¯·é€‰æ‹©</option>
                          <option value="online">åœ¨çº¿æ”¯ä»˜</option>
                          <option value="cod">è´§åˆ°ä»˜æ¬¾</option>
                        </select>
                        {errors.paymentMethod && <p className="text-red-500 text-xs mt-1">{errors.paymentMethod}</p>}
                      </div>
                      {formData.paymentMethod === 'online' && (
                        <div className="md:col-span-2">
                          <label className="font-semibold">ä¸Šä¼ ä»˜æ¬¾å‡­è¯ *</label>
                          <input type="file" onChange={handleFileChange} accept="image/*,.pdf" className="mt-1 w-full p-2 border rounded" />
                          {errors.paymentProof && <p className="text-red-500 text-xs mt-1">{errors.paymentProof}</p>}
                        </div>
                      )}
                    </div>
                  </>
                )}
              </form>
              <div className="p-5 border-t bg-gray-50">
                <button onClick={handleSubmit} className="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition-colors">
                  {isShippingPayment ? 'ç¡®è®¤æ”¯ä»˜è¿è´¹' : 'ç¡®è®¤è®¢å•'}
                </button>
              </div>
            </div>
          </div>
        );
      };

      // ä¸‹å•æˆåŠŸæ¨¡æ€æ¡†
      const OrderSuccessModal = ({ order, onNewOrder }) => {
        const [showDialog, setShowDialog] = useState(true);
        const [showSuccess, setShowSuccess] = useState(false);
        const [hasRedirected, setHasRedirected] = useState(false);
        const whatsappMsg = useMemo(() => buildOrderMessage(order), [order]);
        const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(whatsappMsg)}`;
        const handleCopy = useCallback(async () => {
          const ok = await copyTextUniversal(whatsappMsg);
          if (ok) {
            window.alert('è®¢å•æ¶ˆæ¯å·²å¤åˆ¶ï¼');
          } else {
            window.alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é•¿æŒ‰é€‰æ‹©æ‰‹åŠ¨å¤åˆ¶ã€‚');
          }
        }, [whatsappMsg]);
        const handleSend = () => {
          setShowDialog(false);
          setShowSuccess(true);
        };
        const handleSuccessConfirm = () => {
          if (!hasRedirected) {
            setHasRedirected(true);
            window.location.href = whatsappUrl;
          }
          setShowSuccess(false);
          onNewOrder();
        };
        // è®¢å•ç¡®è®¤å¼¹çª—
        if (showDialog) {
          return (
            <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
              <div className="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col animate-fade-in">
                <div className="p-6 overflow-y-auto">
                  <h2 className="text-xl font-bold text-center mb-4">è®¢å•ç¡®è®¤</h2>
                  <div className="space-y-2 text-sm">
                    <p><strong>è®¢å•å·:</strong> {order.order_id}</p>
                    <p><strong>å§“å:</strong> {order.name}</p>
                    <p><strong>ç”µè¯:</strong> {order.phone}</p>
                    <p><strong>å–è´§æ–¹å¼:</strong> {order.delivery_method === 'self-pickup' ? 'è‡ªå–' : 'Lalamoveé€è´§'}</p>
                    <p><strong>ä»˜æ¬¾æ–¹å¼:</strong> {order.payment_method}</p>
                    <hr className="my-2" />
                    <h3 className="font-semibold">è®¢å•æ˜ç»†:</h3>
                    <ul className="list-disc list-inside pl-4">
                      {order.order_items.map(item => (
                        <li key={item.id}>{item.product || item.name} x {item.quantity} = RM{(Number(item.price) * item.quantity).toFixed(2)}</li>
                      ))}
                    </ul>
                    <hr className="my-2" />
                    <p className="text-right font-bold text-lg">æ€»é‡‘é¢: <span className="text-red-600">RM{Number(order.total_amount).toFixed(2)}</span></p>
                  </div>
                  <div className="whatsapp-preview mt-4 p-3 bg-gray-50 rounded">
                    <strong>å°†å‘é€åˆ°WhatsAppçš„å†…å®¹:</strong>
                    <p style={{ color: 'red', fontWeight: 'bold' }}>è¯·åŠ¡å¿…å¤åˆ¶ä»¥ä¸‹ä¿¡æ¯ï¼Œå¹¶åœ¨è·³è½¬WhatsAppåç‚¹å‡»å‘é€ï¼</p>
                    <button onClick={handleCopy} className="mb-2 px-4 py-2 bg-green-500 text-white rounded">å¤åˆ¶æ¶ˆæ¯</button>
                    <div style={{ whiteSpace: 'pre-wrap', fontFamily: 'monospace', background: '#f5f5f5', padding: '10px', borderRadius: '8px' }}>{whatsappMsg.replace(/\*/g, '')}</div>
                  </div>
                </div>
                <div className="px-6 py-4 bg-gray-50 flex justify-between rounded-b-lg">
                  <button onClick={() => setShowDialog(false)} className="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">
                    å–æ¶ˆ
                  </button>
                  <button onClick={handleSend} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    ç¡®è®¤å¹¶å‘é€
                  </button>
                </div>
              </div>
            </div>
          );
        }
        // å‘é€æˆåŠŸå¼¹çª—
        if (showSuccess) {
          return (
            <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
              <div className="bg-white rounded-lg shadow-xl w-full max-w-md text-center animate-fade-in">
                <div className="p-6">
                  <i className="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                  <h2 className="text-2xl font-bold mb-2">è®¢å•æäº¤æˆåŠŸ!</h2>
                  <p className="text-gray-600 mb-4">è®¢å•å·²æˆåŠŸä¿å­˜ï¼Œè¯·ç‚¹å‡»"å¥½çš„"è·³è½¬åˆ°WhatsAppå‘é€è®¢å•ä¿¡æ¯ã€‚</p>
                  <button onClick={handleSuccessConfirm} className="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors mb-3">å¥½çš„ (OK)</button>
                </div>
              </div>
            </div>
          );
        }
        return null;
      };

      // å®¢æˆ·è§†å›¾ï¼šå•†å“å±•ç¤º + è´­ç‰©è½¦
      const CustomerView = ({ products, cart, addToCart, updateCartQuantity, removeFromCart, cartTotal, showToast, refreshProducts, setLastOrder, onAdminClick, onCheckout }) => {
        const [activeCategory, setActiveCategory] = useState('å…¨éƒ¨');
        const [showCart, setShowCart] = useState(false);
        // è®¡ç®—åˆ†ç±»åˆ—è¡¨
        const categories = useMemo(() => {
          const catSet = new Set();
          products.forEach(p => {
            if (p.category) catSet.add(p.category);
          });
          return ['å…¨éƒ¨', ...Array.from(catSet)];
        }, [products]);
        // æ ¹æ®åˆ†ç±»è¿‡æ»¤å•†å“
        const filteredProducts = useMemo(() => {
          if (activeCategory === 'å…¨éƒ¨') return products;
          return products.filter(p => p.category === activeCategory);
        }, [products, activeCategory]);
        return (
          <div className="max-w-7xl mx-auto p-4">
            <header className="flex justify-between items-center mb-4">
              <h1 className="text-2xl font-bold text-gray-800">é”‹å‘³æ´¾è®¢è´­</h1>
              <button onClick={onAdminClick} className="text-sm text-gray-600 underline">ç®¡ç†å‘˜ç™»å½•</button>
            </header>
            <div className="mb-4 overflow-x-auto">
              <div className="inline-flex space-x-2">
                {categories.map(cat => (
                  <button key={cat} onClick={() => setActiveCategory(cat)} className={`px-4 py-2 text-sm font-semibold rounded-full whitespace-nowrap transition-colors ${activeCategory === cat ? 'bg-red-600 text-white shadow' : 'bg-white text-gray-700 hover:bg-gray-200'}`}>
                    {cat}
                  </button>
                ))}
              </div>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
              {products.length === 0 ? (
                <p className="col-span-full text-center text-gray-500">æš‚æ— å•†å“ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚</p>
              ) : filteredProducts.length === 0 ? (
                <p className="col-span-full text-center text-gray-500">è¯¥åˆ†ç±»ä¸‹æš‚æ— å•†å“ã€‚</p>
              ) : (
                filteredProducts.map(product => (
                  <ProductCard key={product.id} product={product} onAdd={addToCart} />
                ))
              )}
            </div>
            {cart.length > 0 && (
              <button onClick={() => setShowCart(true)} className="fixed bottom-5 right-5 bg-red-600 text-white px-4 py-3 rounded-full shadow-lg flex items-center gap-2">
                <i className="fas fa-shopping-cart"></i>
                è´­ç‰©è½¦ ({cart.reduce((sum, item) => sum + item.quantity, 0)})
              </button>
            )}
            {showCart && (
              <CartDrawer
                cart={cart}
                onClose={() => setShowCart(false)}
                updateQty={updateCartQuantity}
                removeItem={removeFromCart}
                onCheckout={() => { setShowCart(false); onCheckout(); }}
              />
            )}
          </div>
        );
      };

      // ç®¡ç†å‘˜åå°ç•Œé¢ï¼ˆç®€åŒ–ç‰ˆï¼‰
      const AdminPanel = ({ onExit, showToast }) => {
        const [isAuthenticated, setAuthenticated] = useState(false);
        const [password, setPassword] = useState('');
        const [orders, setOrders] = useState([]);
        const [searchTerm, setSearchTerm] = useState('');
        const [isLoading, setIsLoading] = useState(true);
        // è¿è¾“å‡­è¯æ¨¡æ€æ¡†çŠ¶æ€
        const [shippingModalOrder, setShippingModalOrder] = useState(null);
        const [shippingFile, setShippingFile] = useState(null);
        const [isUploadingShipping, setIsUploadingShipping] = useState(false);
        // è¯»å–è®¢å•åˆ—è¡¨
        const fetchOrders = useCallback(async () => {
          setIsLoading(true);
          try {
            const { data, error } = await supabaseClient.from('orders').select('*').order('created_at', { ascending: false });
            if (error) {
              showToast('åŠ è½½åå°æ•°æ®å¤±è´¥: ' + error.message, 'danger');
            } else {
              setOrders(data || []);
            }
          } catch (e) {
            showToast('åŠ è½½åå°æ•°æ®å¤±è´¥: ' + e.message, 'danger');
          }
          setIsLoading(false);
        }, [showToast]);
        // ç™»å½•ååŠ è½½æ•°æ®
        useEffect(() => {
          if (isAuthenticated) {
            fetchOrders();
          }
        }, [isAuthenticated, fetchOrders]);
        // ç™»å½•éªŒè¯
        const handleLogin = (e) => {
          e.preventDefault();
          if (password === ADMIN_PASSWORD) {
            setAuthenticated(true);
            showToast('ç™»å½•æˆåŠŸ', 'success');
          } else {
            showToast('ç®¡ç†å‘˜å¯†ç é”™è¯¯', 'danger');
            setPassword('');
          }
        };
        // æ”¹å˜è®¢å•çŠ¶æ€
        const handleStatusChange = async (orderId, newStatus) => {
          try {
            const { error } = await supabaseClient.from('orders').update({ status: newStatus }).eq('id', orderId);
            if (error) {
              showToast('çŠ¶æ€æ›´æ–°å¤±è´¥: ' + error.message, 'danger');
            } else {
              showToast('è®¢å•çŠ¶æ€å·²æ›´æ–°', 'success');
              fetchOrders();
            }
          } catch (e) {
            showToast('çŠ¶æ€æ›´æ–°å¤±è´¥: ' + e.message, 'danger');
          }
        };
        // æ‰“å¼€ä¸Šä¼ è¿è´¹å‡­è¯æ¨¡æ€æ¡†
        const openShippingModal = (order) => {
          setShippingModalOrder(order);
          setShippingFile(null);
        };
        const closeShippingModal = () => {
          setShippingModalOrder(null);
          setShippingFile(null);
        };
        const handleShippingFileChange = (e) => {
          setShippingFile(e.target.files[0]);
        };
        const uploadShippingProof = async () => {
          if (!shippingFile || !shippingModalOrder) return;
          setIsUploadingShipping(true);
          try {
            const ext = shippingFile.name.split('.').pop();
            const filename = `proofs/${shippingModalOrder.order_id}-shipping.${ext}`;
            const { error: uploadError } = await supabaseClient.storage.from('payment-proofs').upload(filename, shippingFile);
            if (uploadError && !uploadError.message.includes('already exists')) {
              showToast('è¿è´¹å‡­è¯ä¸Šä¼ å¤±è´¥: ' + uploadError.message, 'danger');
              setIsUploadingShipping(false);
              return;
            }
            const { data } = supabaseClient.storage.from('payment-proofs').getPublicUrl(filename);
            const url = data.publicUrl;
            const { error: updErr } = await supabaseClient.from('orders').update({ shipping_proof_url: url }).eq('order_id', shippingModalOrder.order_id);
            if (updErr) {
              showToast('è®¢å•æ›´æ–°å¤±è´¥: ' + updErr.message, 'danger');
            } else {
              showToast('è¿è´¹æ”¯ä»˜æˆåŠŸï¼Œæ„Ÿè°¢æ‚¨çš„ä»˜æ¬¾ï¼', 'success');
              fetchOrders();
              closeShippingModal();
            }
          } catch (err) {
            showToast('ä¸Šä¼ å¤±è´¥: ' + err.message, 'danger');
          }
          setIsUploadingShipping(false);
        };
        // å‘é€è¿è´¹é€šçŸ¥
        const sendShippingWhatsapp = (order) => {
          // å¦‚æœæ˜¯è‡ªå–è®¢å•ï¼Œåˆ™æ— éœ€å‘é€è¿è´¹æ¶ˆæ¯
          if (order.delivery_method === 'self-pickup') {
            showToast('è‡ªå–è®¢å•æ— éœ€æ”¯ä»˜è¿è´¹', 'warning');
            return;
          }
          const items = order.order_items || [];
          const totalItems = Array.isArray(items) ? items.reduce((sum, it) => sum + (it.quantity || 0), 0) : 0;
          const shippingFee = totalItems * 5;
          // æ”¯ä»˜é“¾æ¥åº”è¯¥æŒ‡å‘å½“å‰é¡µé¢çš„åŸŸåï¼Œå¦‚æœåœ¨æ–‡ä»¶ç³»ç»Ÿè¿è¡Œåˆ™ä¸æä¾›æœ‰æ•ˆé“¾æ¥
          const origin = window.location.origin.startsWith('file') ? '' : window.location.origin;
          const paymentLink = `${origin}?order_id=${order.order_id}`;
          const msg =
            `ğŸ“¦ *é”‹å‘³æ´¾è®¢å• #${order.order_id}*\n\n` +
            `äº²çˆ±çš„${order.name}ï¼Œæ‚¨çš„è®¢å•å·²å‡†å¤‡å‘è´§ã€‚\n` +
            'è¯·æ”¯ä»˜è¿è´¹ä»¥å®Œæˆé…é€ã€‚\n' +
            `è®¢å•å·: ${order.order_id}\n` +
            `æ”¶ä»¶äºº: ${order.name}\n` +
            `è”ç³»ç”µè¯: ${order.phone}\n` +
            `é…é€æ–¹å¼: ${order.delivery_method === 'self-pickup' ? 'è‡ªå–' : 'Lalamoveé€è´§'}\n` +
            `è¿è´¹: RM${shippingFee.toFixed(2)} (RM5/ä»¶, å…±${totalItems}ä»¶)\n` +
            (paymentLink ? `æ”¯ä»˜é“¾æ¥: ${paymentLink}\n` : '') +
            'å¦‚å·²æ”¯ä»˜è¯·å¿½ç•¥æ­¤æ¶ˆæ¯ï¼Œè°¢è°¢ï¼';
          const phone = order.phone.startsWith('60') ? order.phone : '60' + order.phone.replace(/^0/, '');
          const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
          window.open(url, '_blank');
        };
        // å¤åˆ¶è®¢å•è¯¦æƒ…
        const copyOrder = async (order) => {
          const msg = buildOrderMessage(order).replace(/\*/g, '');
          const ok = await copyTextUniversal(msg);
          if (ok) {
            showToast('è®¢å•è¯¦æƒ…å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
          }
        };
        // æ ¹æ®æœç´¢è¿‡æ»¤è®¢å•
        const filteredOrders = useMemo(() => {
          const term = searchTerm.trim();
          if (!term) return orders;
          return orders.filter(o => String(o.order_id).includes(term));
        }, [orders, searchTerm]);
        // æœªç™»å½•æ—¶æ˜¾ç¤ºç™»å½•ç•Œé¢
        if (!isAuthenticated) {
          return (
            <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
              <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
                <h2 className="text-2xl font-bold text-center mb-6 text-gray-800">ç®¡ç†å‘˜ç™»å½•</h2>
                <form onSubmit={handleLogin} className="space-y-4">
                  <input
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç "
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500"
                    autoFocus
                  />
                  <button type="submit" className="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors shadow-md">
                    ç™»å½•
                  </button>
                  <button type="button" onClick={onExit} className="w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                    è¿”å›å•†åº—
                  </button>
                </form>
              </div>
            </div>
          );
        }
        // ç®¡ç†å‘˜ç•Œé¢
        return (
          <div className="min-h-screen bg-gray-100 p-4">
            <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
              <h1 className="text-3xl font-bold text-gray-800">ç®¡ç†åå°</h1>
              <button onClick={onExit} className="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                è¿”å›å•†åº—
              </button>
            </header>
            <div className="mb-4">
              <label className="font-semibold mr-2">æœç´¢è®¢å•å·:</label>
              <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="p-2 border border-gray-300 rounded" placeholder="è¾“å…¥è®¢å•å·æœç´¢" />
            </div>
            {isLoading ? (
              <div className="flex justify-center p-10"><LoadingSpinner /></div>
            ) : (
              <div className="bg-white rounded-lg shadow-md p-4 overflow-x-auto">
                {filteredOrders.length === 0 ? (
                  <p className="text-center text-gray-500">æš‚æ— è®¢å•</p>
                ) : (
                  <table className="min-w-full divide-y divide-gray-200 text-sm">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">è®¢å•å·</th>
                        <th className="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">å®¢æˆ·</th>
                        <th className="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">ç”µè¯</th>
                        <th className="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">å–è´§æ–¹å¼</th>
                        <th className="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">çŠ¶æ€</th>
                        <th className="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">æ€»é‡‘é¢</th>
                        <th className="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {filteredOrders.map(order => (
                        <tr key={order.id}>
                          <td className="px-4 py-2 whitespace-nowrap font-medium">{order.order_id}</td>
                          <td className="px-4 py-2 whitespace-nowrap">{order.name}</td>
                          <td className="px-4 py-2 whitespace-nowrap">{order.phone}</td>
                          <td className="px-4 py-2 whitespace-nowrap">{order.delivery_method === 'self-pickup' ? 'è‡ªå–' : 'Lalamoveé€è´§'}</td>
                          <td className="px-4 py-2 whitespace-nowrap">
                            <select value={order.status || 'pending'} onChange={(e) => handleStatusChange(order.id, e.target.value)} className={`px-2 py-1 rounded ${getStatusStyle(order.status)}`}>
                              {Object.keys(statusOptions).map(key => (
                                <option key={key} value={key}>{statusOptions[key].label}</option>
                              ))}
                            </select>
                          </td>
                          <td className="px-4 py-2 whitespace-nowrap text-red-600 font-bold">RM{parseFloat(order.total_amount).toFixed(2)}</td>
                          <td className="px-4 py-2 whitespace-nowrap">
                            <div className="flex flex-wrap gap-2">
                              {/* è®¢å•ä»˜æ¬¾å‡­è¯æŸ¥çœ‹ */}
                              {order.payment_proof_url && (
                                <a
                                  href={order.payment_proof_url}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200"
                                >
                                  æŸ¥çœ‹ä»˜æ¬¾å‡­è¯
                                </a>
                              )}
                              {/* è¿è´¹å‡­è¯æŸ¥çœ‹ */}
                              {order.shipping_proof_url && (
                                <a
                                  href={order.shipping_proof_url}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200"
                                >
                                  æŸ¥çœ‹è¿è´¹å‡­è¯
                                </a>
                              )}
                              {/* å¦‚æœæ˜¯é…é€è®¢å•æ‰æ˜¾ç¤ºè¿è´¹ç›¸å…³åŠŸèƒ½ */}
                              {order.delivery_method !== 'self-pickup' && (
                                <>
                                  <button
                                    onClick={() => openShippingModal(order)}
                                    className="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200"
                                  >
                                    ä¸Šä¼ è¿è´¹å‡­è¯
                                  </button>
                                  <button
                                    onClick={() => sendShippingWhatsapp(order)}
                                    className="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700 hover:bg-green-200"
                                  >
                                    å‘é€è¿è´¹é€šçŸ¥
                                  </button>
                                </>
                              )}
                              <button
                                onClick={() => copyOrder(order)}
                                className="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-700 hover:bg-yellow-200"
                              >
                                å¤åˆ¶ä¿¡æ¯
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                )}
              </div>
            )}
            {shippingModalOrder && (
              <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
                  <div className="p-4 border-b flex justify-between items-center">
                    <h3 className="text-lg font-bold">ä¸Šä¼ è¿è´¹å‡­è¯</h3>
                    <button onClick={closeShippingModal} className="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                  </div>
                  <div className="p-4">
                    <input type="file" onChange={handleShippingFileChange} accept="image/*,.pdf" className="w-full p-2 border border-gray-300 rounded" />
                  </div>
                  <div className="p-4 border-t flex justify-end">
                    <button onClick={uploadShippingProof} disabled={isUploadingShipping || !shippingFile} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-300">
                      {isUploadingShipping ? 'ä¸Šä¼ ä¸­...' : 'ä¸Šä¼ '}
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      };

      // ä¸»åº”ç”¨ç»„ä»¶
      function App() {
        const [view, setView] = useState('customer');
        const [products, setProducts] = useState([]);
        const [cart, setCart] = useState([]);
        const [isLoading, setIsLoading] = useState(true);
        const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
        const [lastOrder, setLastOrder] = useState(null);
        const [showCheckoutModal, setShowCheckoutModal] = useState(false);
        // æ˜¾ç¤ºé€šçŸ¥
        const showToastMessage = (message, type = 'success') => {
          setToast({ show: true, message, type });
        };
        // è·å–å•†å“åˆ—è¡¨
        const fetchProducts = useCallback(async () => {
          setIsLoading(true);
          try {
            const { data, error } = await supabaseClient.from('products').select('*').order('id');
            if (error) {
              showToastMessage('åŠ è½½å•†å“å¤±è´¥: ' + error.message, 'danger');
            } else {
              const formatted = (data || []).map(p => {
                let imgUrl = '';
                if (p.image_url) {
                  imgUrl = p.image_url;
                } else if (p.image) {
                  const rawName = String(p.image).trim();
                  imgUrl = rawName.startsWith('http') ? rawName : (PRODUCT_IMAGE_BASE_URL + encodeURIComponent(rawName));
                }
                return {
                  ...p,
                  image: imgUrl,
                  price: Number(p.price) || 0,
                  stock: p.is_unlimited ? Infinity : (p.stock_quantity ?? 0),
                  is_unlimited: !!p.is_unlimited,
                  emoji: p.emoji || '',
                  category: p.category || 'å…¶ä»–'
                };
              });
              setProducts(formatted);
            }
          } catch (e) {
            showToastMessage('åŠ è½½å•†å“å¤±è´¥: ' + e.message, 'danger');
          }
          setIsLoading(false);
        }, []);
        // åˆå§‹åŒ–åŠ è½½å•†å“
        useEffect(() => {
          fetchProducts();
        }, [fetchProducts]);
        // æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
        const addToCart = (product) => {
          setCart(prev => {
            const existing = prev.find(item => item.id === product.id);
            if (existing) {
              if (product.is_unlimited || existing.quantity < product.stock) {
                showToastMessage(`${product.name} å·²æ·»åŠ åˆ°è´­ç‰©è½¦`, 'success');
                return prev.map(item => item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item);
              } else {
                showToastMessage(`${product.name} åº“å­˜ä¸è¶³`, 'warning');
                return prev;
              }
            }
            showToastMessage(`${product.name} å·²æ·»åŠ åˆ°è´­ç‰©è½¦`, 'success');
            return [...prev, { ...product, quantity: 1 }];
          });
        };
        // æ›´æ–°è´­ç‰©è½¦æ•°é‡
        const updateCartQuantity = (id, qty) => {
          setCart(prev => prev.map(item => {
            if (item.id === id) {
              if (qty <= 0) {
                return null;
              }
              if (!item.is_unlimited && qty > item.stock) {
                showToastMessage(`åº“å­˜ä¸è¶³ï¼Œæœ€å¤šå¯è´­ä¹° ${item.stock} ä»¶`, 'warning');
                return { ...item, quantity: item.stock };
              }
              return { ...item, quantity: qty };
            }
            return item;
          }).filter(Boolean));
        };
        // ä»è´­ç‰©è½¦åˆ é™¤
        const removeFromCart = (id) => {
          setCart(prev => prev.filter(item => item.id !== id));
        };
        // è´­ç‰©è½¦æ€»é‡‘é¢
        const cartTotal = useMemo(() => {
          return cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        }, [cart]);
        // å¤„ç†ç»“è´¦æŒ‰é’®ç‚¹å‡»
        const handleCheckout = () => {
          setShowCheckoutModal(true);
        };
        // å¤„ç†è®¢å•æäº¤
        const handleOrderConfirm = async (formData, paymentProof, isShippingPayment) => {
          if (isShippingPayment) {
            // è¿è´¹æ”¯ä»˜ï¼šæ›´æ–°å·²æœ‰è®¢å•
            let orderId = null;
            try {
              const params = new URLSearchParams(window.location.search);
              orderId = params.get('order_id');
            } catch (e) {
              // ignore
            }
            if (!orderId) {
              showToastMessage('è®¢å•ç¼–å·ä¸å­˜åœ¨', 'danger');
              return;
            }
            let proofUrl = null;
            if (paymentProof) {
              try {
                const ext = paymentProof.name.split('.').pop();
                const filename = `proofs/${orderId}-shipping.${ext}`;
                const { error: uploadError } = await supabaseClient.storage.from('payment-proofs').upload(filename, paymentProof);
                if (uploadError && !uploadError.message.includes('already exists')) {
                  showToastMessage('æ”¯ä»˜å‡­è¯ä¸Šä¼ å¤±è´¥: ' + uploadError.message, 'danger');
                  return;
                }
                const { data } = supabaseClient.storage.from('payment-proofs').getPublicUrl(filename);
                proofUrl = data.publicUrl;
              } catch (e) {
                showToastMessage('æ”¯ä»˜å‡­è¯ä¸Šä¼ å¤±è´¥: ' + e.message, 'danger');
                return;
              }
            }
            try {
              const { error: updErr } = await supabaseClient.from('orders').update({ shipping_payment_proof_url: proofUrl, shipping_remarks: formData.remarks }).eq('order_id', orderId);
              if (updErr) {
                showToastMessage('è®¢å•æ›´æ–°å¤±è´¥: ' + updErr.message, 'danger');
              } else {
                showToastMessage('æ”¯ä»˜å‡­è¯å·²ä¸Šä¼ ï¼Œæ„Ÿè°¢æ‚¨çš„ä»˜æ¬¾ï¼', 'success');
              }
            } catch (e) {
              showToastMessage('è®¢å•æ›´æ–°å¤±è´¥: ' + e.message, 'danger');
            }
            setShowCheckoutModal(false);
            return;
          }
          // æ–°è®¢å•
          const orderId = 'FW' + Date.now();
          let proofUrl = null;
          if (paymentProof) {
            try {
              const ext = paymentProof.name.split('.').pop();
              const filename = `proofs/${orderId}.${ext}`;
              const { error: uploadError } = await supabaseClient.storage.from('payment-proofs').upload(filename, paymentProof);
              if (uploadError && !uploadError.message.includes('already exists')) {
                showToastMessage('æ”¯ä»˜å‡­è¯ä¸Šä¼ å¤±è´¥: ' + uploadError.message, 'danger');
                return;
              }
              const { data } = supabaseClient.storage.from('payment-proofs').getPublicUrl(filename);
              proofUrl = data.publicUrl;
            } catch (e) {
              showToastMessage('æ”¯ä»˜å‡­è¯ä¸Šä¼ å¤±è´¥: ' + e.message, 'danger');
              return;
            }
          }
          // æ„å»ºè®¢å•æ•°æ®
          const orderData = {
            order_id: orderId,
            name: formData.name,
            phone: formData.phone,
            delivery_method: formData.delivery,
            payment_method: formData.paymentMethod,
            address: formData.delivery === 'lalamove' ? formData.address : null,
            remarks: formData.remarks,
            total_amount: cartTotal,
            status: 'pending',
            created_at: new Date().toISOString(),
            payment_proof_url: proofUrl,
            order_items: cart.map(item => ({
              id: item.id,
              product: item.name,
              quantity: item.quantity,
              price: item.price,
              emoji: item.emoji,
              is_unlimited: item.is_unlimited
            }))
          };
          try {
            const { data, error } = await supabaseClient.from('orders').insert([orderData]).select().single();
            if (error) {
              showToastMessage('ä¸‹å•å¤±è´¥: ' + error.message, 'danger');
            } else {
              showToastMessage('ä¸‹å•æˆåŠŸï¼Œè¯·ç»§ç»­ WhatsApp ç¡®è®¤ï¼', 'success');
              setLastOrder(orderData);
              setCart([]);
            }
          } catch (e) {
            showToastMessage('ä¸‹å•å¤±è´¥: ' + e.message, 'danger');
          }
          setShowCheckoutModal(false);
        };
        // æ–°è®¢å•å®Œæˆåé‡ç½®
        const handleNewOrder = () => {
          setLastOrder(null);
          setCart([]);
        };
        return (
          <div>
            {toast.show && (
              <div className="fixed top-5 right-5 z-50">
                <Toast message={toast.message} type={toast.type} onDismiss={() => setToast({ show: false, message: '', type: 'success' })} />
              </div>
            )}
            {view === 'customer' && (
              <>
                {isLoading ? (
                  <div className="flex justify-center py-20"><LoadingSpinner text="åŠ è½½å•†å“ä¸­..." /></div>
                ) : (
                  <CustomerView
                    products={products}
                    cart={cart}
                    addToCart={addToCart}
                    updateCartQuantity={updateCartQuantity}
                    removeFromCart={removeFromCart}
                    cartTotal={cartTotal}
                    showToast={showToastMessage}
                    refreshProducts={fetchProducts}
                    setLastOrder={setLastOrder}
                    onAdminClick={() => setView('admin')}
                    onCheckout={handleCheckout}
                  />
                )}
              </>
            )}
            {view === 'admin' && (
              <AdminPanel onExit={() => setView('customer')} showToast={showToastMessage} />
            )}
            {showCheckoutModal && (
              <CheckoutModal cart={cart} total={cartTotal} onClose={() => setShowCheckoutModal(false)} onConfirm={handleOrderConfirm} />
            )}
            {lastOrder && (
              <OrderSuccessModal order={lastOrder} onNewOrder={handleNewOrder} />
            )}
          </div>
        );
      }

      // æ¸²æŸ“åº”ç”¨
      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
