<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>锋味派订购系统</title>
    <!-- Icons and theme colors -->
    <link rel="icon" type="image/jpeg" href="fengwei/icon3.jpg">
    <meta name="theme-color" content="#d10000">
    <link rel="apple-touch-icon" href="https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/icon-512x512.png">
    <!-- External libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      /* Animations used throughout the app */
      @keyframes slide-in-down { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      .animate-slide-in-down { animation: slide-in-down 0.3s ease-out forwards; }
      @keyframes slide-in-right { from { transform: translateX(100%); } to { transform: translateX(0); } }
      .animate-slide-in-right { animation: slide-in-right 0.3s ease-out forwards; }
      @keyframes fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
      .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>
    <!-- Main application script -->
    <script type="text/babel">
      const { useState, useEffect, useCallback, useMemo, useRef } = React;

      // --- Supabase configuration & constants ---
      const SUPABASE_URL = 'https://edfnhhthztskuuosuasw.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZm5oaHRoenRza3V1b3N1YXN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5OTYxMTYsImV4cCI6MjA2NTU3MjExNn0.O3g2gjvsWagmWgmzoeJA8mPampvLYJr-KgqVwXsKoAo';
      const WHATSAPP_NUMBER = '60162327792';
      const ADMIN_PASSWORD = 'fengweipaiadmin';
      const SELF_PICKUP_ADDRESS = '667, Jalan 24, Taman Perindustrian Ehsan Jaya, Kepong, 52100, Kuala Lumpur.';
      const PRODUCT_IMAGE_BASE_URL = 'https://edfnhhthztskuuosuasw.supabase.co/storage/v1/object/public/product-photos/';

      // Initialise Supabase client
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // 状态选项，用于后台显示与选择
      const statusOptions = {
        pending: { label: '待处理', color: 'bg-yellow-200 text-yellow-800' },
        'ready for pick up': { label: '待自取', color: 'bg-blue-200 text-blue-800' },
        delivered: { label: '已发货', color: 'bg-indigo-200 text-indigo-800' },
        completed: { label: '已完成', color: 'bg-green-200 text-green-800' },
        cancelled: { label: '已取消', color: 'bg-red-200 text-red-800' }
      };
      const getStatusStyle = (status) => {
        return statusOptions[status]?.color || 'bg-gray-200 text-gray-800';
      };

      /*
       * -----------------------------------------------------------------------------
       * 工具函数
       *  1. buildOrderMessage(order): 根据订单对象生成 WhatsApp 消息文本。
       *  2. copyTextUniversal(text): 兼容性好的文本复制函数。
       */
      function buildOrderMessage(order) {
        try {
          let msg = `🛎️ *锋味派新订单 #${order.order_id}*\n\n`;
          msg += '👤 *客户信息*\n';
          msg += `📛 姓名: ${order.name}\n`;
          msg += `📱 电话: ${order.phone}\n`;
          msg += `🚚 取货方式: ${order.delivery_method === 'self-pickup' ? '自取' : 'Lalamove送货'}\n`;
          if (order.delivery_method === 'self-pickup') {
            msg += `📍 自取地址: ${SELF_PICKUP_ADDRESS}\n`;
            msg += '⏰ 取货时间: 另行通知\n';
            msg += `📞 联络号码: ${WHATSAPP_NUMBER.replace(/^60/, '0')}\n`;
          } else {
            if (order.address) {
              msg += `📍 配送地址: ${order.address}\n`;
            }
          }
          msg += '\n🛒 *订单明细*\n';
          if (Array.isArray(order.order_items)) {
            order.order_items.forEach(item => {
              let emoji = item.emoji || '';
              if (!emoji) {
                const n = item.product || item.name || '';
                if (n.includes('烤肠')) emoji = '🌭';
                else if (n.includes('虾')) emoji = '🦐';
                else if (n.includes('披萨')) emoji = '🍕';
                else if (n.includes('汤包')) emoji = '🥟';
                else if (n.includes('酥饼')) emoji = '🥮';
                else if (n.includes('鸡排') || n.includes('鸡翅')) emoji = '🍗';
                else emoji = '▫️';
              }
              const typeLabel = item.is_unlimited ? ' (预购)' : ' (现货)';
              msg += `${emoji} ${item.product || item.name}${typeLabel} × ${item.quantity} = RM${(item.quantity * item.price).toFixed(2)}\n`;
            });
          }
          msg += `\n💰 *总金额: RM${Number(order.total_amount).toFixed(2)}*\n`;
          msg += `📝 *备注*: ${order.remarks || '无'}\n`;
          const createdAt = order.created_at ? new Date(order.created_at) : new Date();
          msg += `📅 *下单时间*: ${createdAt.toLocaleString('zh-CN')}`;
          return msg;
        } catch (e) {
          console.error('[buildOrderMessage] error:', e, order);
          return '订单信息生成失败，请联系管理员。';
        }
      }

      async function copyTextUniversal(text) {
        // 现代 Clipboard API
        try {
          if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
            await navigator.clipboard.writeText(text);
            return true;
          }
        } catch (e) {
          // ignore and fallback
        }
        // 回退方案
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.setAttribute('readonly', '');
          ta.style.position = 'fixed';
          ta.style.top = '-10000px';
          document.body.appendChild(ta);
          ta.select();
          ta.setSelectionRange(0, ta.value.length);
          const ok = document.execCommand('copy');
          document.body.removeChild(ta);
          return ok;
        } catch (e) {
          console.error('[copyTextUniversal] fallback error:', e);
          return false;
        }
      }

      // Toast 组件，用于显示临时消息
      const Toast = ({ message, type, onDismiss }) => {
        const typeClasses = {
          success: 'text-green-500',
          danger: 'text-red-500',
          warning: 'text-yellow-500'
        };
        const icons = {
          success: <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd"></path></svg>,
          danger: <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd"></path></svg>,
          warning: <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M8.257 3.099c.636-1.214 2.852-1.214 3.488 0l6.114 11.638c.636 1.214-.474 2.763-1.744 2.763H3.887c-1.27 0-2.38-1.549-1.744-2.763L8.257 3.099zM10 6a1 1 0 011 1v4a1 1 0 11-2 0V7a1 1 0 011-1zm-1 8a1 1 0 102 0 1 1 0 00-2 0z" clipRule="evenodd"></path></svg>
        };
        // 自动3秒后消失
        useEffect(() => {
          const timer = setTimeout(onDismiss, 3000);
          return () => clearTimeout(timer);
        }, [onDismiss]);
        return (
          <div className="animate-slide-in-down flex items-center w-full max-w-xs p-4 space-x-4 bg-white rounded-lg shadow-lg">
            <div className={`flex-shrink-0 ${typeClasses[type]}`}>{icons[type]}</div>
            <div className="pl-2 text-sm font-normal">{message}</div>
          </div>
        );
      };

      // 加载中指示器
      const LoadingSpinner = ({ text }) => (
        <div className="text-center">
          <svg className="mx-auto h-12 w-12 text-red-600 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          {text && <p className="mt-2 text-lg font-semibold text-gray-700">{text}</p>}
        </div>
      );

      // 商品卡片组件
      const ProductCard = ({ product, onAdd }) => {
        const isOutOfStock = !product.is_unlimited && product.stock !== Infinity && product.stock <= 0;
        const productTypeLabel = product.is_unlimited ? '(预购)' : '(现货)';
        return (
          <div className={`bg-white rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 flex flex-col overflow-hidden ${isOutOfStock ? 'opacity-60 bg-gray-100' : ''}`}>
            <div className="w-full h-52 bg-gray-200 flex items-center justify-center overflow-hidden">
              <img src={product.image} alt={product.name} className="w-full h-full object-contain" onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/400x400/cccccc/ffffff?text=Image+Error'; }} />
            </div>
            <div className="p-5 flex flex-col flex-grow">
              <h3 className="text-lg font-bold text-gray-800">{product.emoji} {product.name} <span className="text-sm font-normal text-gray-500">{productTypeLabel}</span></h3>
              <p className="text-sm text-gray-500 mb-3">库存: {product.is_unlimited ? '充足' : product.stock}</p>
              <div className="mt-auto flex justify-between items-center">
                <p className="text-xl font-extrabold text-red-600">RM{product.price.toFixed(2)}</p>
                <button onClick={() => onAdd(product)} disabled={isOutOfStock} className="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-2">
                  <i className="fas fa-cart-plus"></i>
                  添加
                </button>
              </div>
            </div>
          </div>
        );
      };

      // 购物车抽屉
      const CartDrawer = ({ cart, onClose, updateQty, removeItem, onCheckout }) => {
        const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        return (
          <div className="fixed inset-0 z-50 flex justify-end items-stretch">
            <div className="absolute inset-0 bg-black bg-opacity-50" onClick={onClose}></div>
            <div className="relative bg-white w-full max-w-md h-full overflow-y-auto shadow-lg animate-slide-in-right flex flex-col">
              <div className="p-5 flex justify-between items-center border-b">
                <h2 className="text-lg font-bold">购物车</h2>
                <button onClick={onClose} className="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
              </div>
              <div className="p-5 space-y-4 flex-1 overflow-y-auto">
                {cart.length === 0 ? (
                  <p className="text-center text-gray-500">购物车为空</p>
                ) : (
                  cart.map(item => (
                    <div key={item.id} className="flex justify-between items-center">
                      <div>
                        <p className="font-semibold">{item.name}</p>
                        <p className="text-sm text-gray-500">RM{item.price.toFixed(2)}</p>
                      </div>
                      <div className="flex items-center">
                        <button onClick={() => updateQty(item.id, item.quantity - 1)} disabled={item.quantity <= 1} className="w-7 h-7 rounded-md bg-gray-200 text-gray-800 hover:bg-gray-300 transition-colors active:scale-90">-</button>
                        <span className="px-3">{item.quantity}</span>
                        <button onClick={() => updateQty(item.id, item.quantity + 1)} disabled={!item.is_unlimited && item.quantity >= item.stock} className="w-7 h-7 rounded-md bg-gray-200 text-gray-800 hover:bg-gray-300 transition-colors active:scale-90">+</button>
                      </div>
                      <button onClick={() => removeItem(item.id)} className="text-gray-400 hover:text-red-500 transition-colors ml-2">
                        <i className="fas fa-trash-alt"></i>
                      </button>
                    </div>
                  ))
                )}
              </div>
              <div className="p-5 border-t">
                <div className="flex justify-between items-center mb-3">
                  <span className="font-semibold text-gray-800">总计:</span>
                  <span className="font-extrabold text-red-600 text-2xl">RM{total.toFixed(2)}</span>
                </div>
                <button onClick={onCheckout} disabled={cart.length === 0} className="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-red-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                  <i className="fa fa-credit-card"></i>
                  立即结账
                </button>
              </div>
            </div>
          </div>
        );
      };

      // 结账/支付模态框
      const CheckoutModal = ({ cart, total, onClose, onConfirm }) => {
        const [formData, setFormData] = useState({ name: '', phone: '', delivery: '', remarks: '', paymentMethod: '', address: '' });
        const [paymentProof, setPaymentProof] = useState(null);
        const [errors, setErrors] = useState({});
        const [isShippingPayment, setIsShippingPayment] = useState(false);
        // 判断是否为运费支付
        useEffect(() => {
          try {
            const params = new URLSearchParams(window.location.search);
            if (params.get('order_id')) {
              setIsShippingPayment(true);
            }
          } catch (e) {
            // ignore
          }
        }, []);
        // 校验表单
        const validate = () => {
          const newErrors = {};
          if (isShippingPayment) {
            if (!paymentProof) newErrors.paymentProof = '请上传支付凭证';
            if (!formData.remarks) newErrors.remarks = '请填写配送资料';
          } else {
            if (!formData.name) newErrors.name = '请输入姓名';
            if (!formData.phone) newErrors.phone = '请输入电话';
            if (!formData.delivery) newErrors.delivery = '请选择取货方式';
            if (formData.delivery === 'lalamove' && !formData.address) newErrors.address = '请输入配送地址';
            if (!formData.paymentMethod) newErrors.paymentMethod = '请选择付款方式';
            if (formData.paymentMethod === 'online' && !paymentProof) newErrors.paymentProof = '请上传支付凭证';
          }
          setErrors(newErrors);
          return Object.keys(newErrors).length === 0;
        };
        const handleChange = (e) => {
          setFormData({ ...formData, [e.target.name]: e.target.value });
        };
        const handleFileChange = (e) => {
          const file = e.target.files[0];
          if (file) {
            setPaymentProof(file);
          }
        };
        const handleSubmit = (e) => {
          e.preventDefault();
          if (!validate()) return;
          onConfirm(formData, paymentProof, isShippingPayment);
        };
        return (
          <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col animate-fade-in">
              <div className="flex justify-between items-center p-5 border-b">
                <h2 className="text-xl font-bold">{isShippingPayment ? '支付运费' : '填写订单信息'}</h2>
                <button onClick={onClose} className="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
              </div>
              <form onSubmit={handleSubmit} className="flex-grow overflow-y-auto p-6 space-y-6">
                {isShippingPayment ? (
                  <>
                    <div className="p-4 bg-blue-50 border-l-4 border-blue-400 text-blue-700 mb-4">
                      <h4 className="font-bold">请上传运费支付凭证，并填写配送资料</h4>
                    </div>
                    <div>
                      <label className="font-semibold">上传转账凭证 *</label>
                      <input type="file" onChange={handleFileChange} accept="image/*,.pdf" className="mt-1 w-full p-2 border rounded" />
                      {errors.paymentProof && <p className="text-red-500 text-xs mt-1">{errors.paymentProof}</p>}
                    </div>
                    <div>
                      <label className="font-semibold">配送资料 *</label>
                      <textarea name="remarks" value={formData.remarks} onChange={handleChange} rows="3" className="w-full mt-1 p-2 border rounded"></textarea>
                      {errors.remarks && <p className="text-red-500 text-xs mt-1">{errors.remarks}</p>}
                    </div>
                  </>
                ) : (
                  <>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                        <label className="font-semibold">姓名 *</label>
                        <input type="text" name="name" value={formData.name} onChange={handleChange} className={`w-full mt-1 p-2 border rounded ${errors.name ? 'border-red-500' : 'border-gray-300'}`} />
                        {errors.name && <p className="text-red-500 text-xs mt-1">{errors.name}</p>}
                      </div>
                      <div>
                        <label className="font-semibold">电话 *</label>
                        <input type="tel" name="phone" value={formData.phone} onChange={handleChange} className={`w-full mt-1 p-2 border rounded ${errors.phone ? 'border-red-500' : 'border-gray-300'}`} />
                        {errors.phone && <p className="text-red-500 text-xs mt-1">{errors.phone}</p>}
                      </div>
                      <div>
                        <label className="font-semibold">取货方式 *</label>
                        <select name="delivery" value={formData.delivery} onChange={handleChange} className={`w-full mt-1 p-2 border rounded ${errors.delivery ? 'border-red-500' : 'border-gray-300'}`}> 
                          <option value="">请选择</option>
                          <option value="self-pickup">自取</option>
                          <option value="lalamove">Lalamove</option>
                        </select>
                        {errors.delivery && <p className="text-red-500 text-xs mt-1">{errors.delivery}</p>}
                      </div>
                      {formData.delivery === 'lalamove' && (
                        <div className="md:col-span-2">
                          <label className="font-semibold">配送地址 *</label>
                          <input type="text" name="address" value={formData.address} onChange={handleChange} className={`w-full mt-1 p-2 border rounded ${errors.address ? 'border-red-500' : 'border-gray-300'}`} placeholder="请输入详细配送地址" />
                          {errors.address && <p className="text-red-500 text-xs mt-1">{errors.address}</p>}
                        </div>
                      )}
                      <div>
                        <label className="font-semibold">备注</label>
                        <textarea name="remarks" value={formData.remarks} onChange={handleChange} rows="2" className="w-full mt-1 p-2 border border-gray-300 rounded"></textarea>
                      </div>
                      <div>
                        <label className="font-semibold">付款方式 *</label>
                        <select name="paymentMethod" value={formData.paymentMethod} onChange={handleChange} className={`w-full mt-1 p-2 border rounded ${errors.paymentMethod ? 'border-red-500' : 'border-gray-300'}`}> 
                          <option value="">请选择</option>
                          <option value="online">在线支付</option>
                          <option value="cod">货到付款</option>
                        </select>
                        {errors.paymentMethod && <p className="text-red-500 text-xs mt-1">{errors.paymentMethod}</p>}
                      </div>
                      {formData.paymentMethod === 'online' && (
                        <div className="md:col-span-2">
                          <label className="font-semibold">上传付款凭证 *</label>
                          <input type="file" onChange={handleFileChange} accept="image/*,.pdf" className="mt-1 w-full p-2 border rounded" />
                          {errors.paymentProof && <p className="text-red-500 text-xs mt-1">{errors.paymentProof}</p>}
                        </div>
                      )}
                    </div>
                  </>
                )}
              </form>
              <div className="p-5 border-t bg-gray-50">
                <button onClick={handleSubmit} className="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition-colors">
                  {isShippingPayment ? '确认支付运费' : '确认订单'}
                </button>
              </div>
            </div>
          </div>
        );
      };

      // 下单成功模态框
      const OrderSuccessModal = ({ order, onNewOrder }) => {
        const [showDialog, setShowDialog] = useState(true);
        const [showSuccess, setShowSuccess] = useState(false);
        const [hasRedirected, setHasRedirected] = useState(false);
        const whatsappMsg = useMemo(() => buildOrderMessage(order), [order]);
        const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(whatsappMsg)}`;
        const handleCopy = useCallback(async () => {
          const ok = await copyTextUniversal(whatsappMsg);
          if (ok) {
            window.alert('订单消息已复制！');
          } else {
            window.alert('复制失败，请长按选择手动复制。');
          }
        }, [whatsappMsg]);
        const handleSend = () => {
          setShowDialog(false);
          setShowSuccess(true);
        };
        const handleSuccessConfirm = () => {
          if (!hasRedirected) {
            setHasRedirected(true);
            window.location.href = whatsappUrl;
          }
          setShowSuccess(false);
          onNewOrder();
        };
        // 订单确认弹窗
        if (showDialog) {
          return (
            <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
              <div className="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col animate-fade-in">
                <div className="p-6 overflow-y-auto">
                  <h2 className="text-xl font-bold text-center mb-4">订单确认</h2>
                  <div className="space-y-2 text-sm">
                    <p><strong>订单号:</strong> {order.order_id}</p>
                    <p><strong>姓名:</strong> {order.name}</p>
                    <p><strong>电话:</strong> {order.phone}</p>
                    <p><strong>取货方式:</strong> {order.delivery_method === 'self-pickup' ? '自取' : 'Lalamove送货'}</p>
                    <p><strong>付款方式:</strong> {order.payment_method}</p>
                    <hr className="my-2" />
                    <h3 className="font-semibold">订单明细:</h3>
                    <ul className="list-disc list-inside pl-4">
                      {order.order_items.map(item => (
                        <li key={item.id}>{item.product || item.name} x {item.quantity} = RM{(Number(item.price) * item.quantity).toFixed(2)}</li>
                      ))}
                    </ul>
                    <hr className="my-2" />
                    <p className="text-right font-bold text-lg">总金额: <span className="text-red-600">RM{Number(order.total_amount).toFixed(2)}</span></p>
                  </div>
                  <div className="whatsapp-preview mt-4 p-3 bg-gray-50 rounded">
                    <strong>将发送到WhatsApp的内容:</strong>
                    <p style={{ color: 'red', fontWeight: 'bold' }}>请务必复制以下信息，并在跳转WhatsApp后点击发送！</p>
                    <button onClick={handleCopy} className="mb-2 px-4 py-2 bg-green-500 text-white rounded">复制消息</button>
                    <div style={{ whiteSpace: 'pre-wrap', fontFamily: 'monospace', background: '#f5f5f5', padding: '10px', borderRadius: '8px' }}>{whatsappMsg.replace(/\*/g, '')}</div>
                  </div>
                </div>
                <div className="px-6 py-4 bg-gray-50 flex justify-between rounded-b-lg">
                  <button onClick={() => setShowDialog(false)} className="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">
                    取消
                  </button>
                  <button onClick={handleSend} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    确认并发送
                  </button>
                </div>
              </div>
            </div>
          );
        }
        // 发送成功弹窗
        if (showSuccess) {
          return (
            <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
              <div className="bg-white rounded-lg shadow-xl w-full max-w-md text-center animate-fade-in">
                <div className="p-6">
                  <i className="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                  <h2 className="text-2xl font-bold mb-2">订单提交成功!</h2>
                  <p className="text-gray-600 mb-4">订单已成功保存，请点击"好的"跳转到WhatsApp发送订单信息。</p>
                  <button onClick={handleSuccessConfirm} className="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors mb-3">好的 (OK)</button>
                </div>
              </div>
            </div>
          );
        }
        return null;
      };

      // 客户视图：商品展示 + 购物车
      const CustomerView = ({ products, cart, addToCart, updateCartQuantity, removeFromCart, cartTotal, showToast, refreshProducts, setLastOrder, onAdminClick, onCheckout }) => {
        const [activeCategory, setActiveCategory] = useState('全部');
        const [showCart, setShowCart] = useState(false);
        // 计算分类列表
        const categories = useMemo(() => {
          const catSet = new Set();
          products.forEach(p => {
            if (p.category) catSet.add(p.category);
          });
          return ['全部', ...Array.from(catSet)];
        }, [products]);
        // 根据分类过滤商品
        const filteredProducts = useMemo(() => {
          if (activeCategory === '全部') return products;
          return products.filter(p => p.category === activeCategory);
        }, [products, activeCategory]);
        return (
          <div className="max-w-7xl mx-auto p-4">
            <header className="flex justify-between items-center mb-4">
              <h1 className="text-2xl font-bold text-gray-800">锋味派订购</h1>
              <button onClick={onAdminClick} className="text-sm text-gray-600 underline">管理员登录</button>
            </header>
            <div className="mb-4 overflow-x-auto">
              <div className="inline-flex space-x-2">
                {categories.map(cat => (
                  <button key={cat} onClick={() => setActiveCategory(cat)} className={`px-4 py-2 text-sm font-semibold rounded-full whitespace-nowrap transition-colors ${activeCategory === cat ? 'bg-red-600 text-white shadow' : 'bg-white text-gray-700 hover:bg-gray-200'}`}>
                    {cat}
                  </button>
                ))}
              </div>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
              {products.length === 0 ? (
                <p className="col-span-full text-center text-gray-500">暂无商品，请联系管理员。</p>
              ) : filteredProducts.length === 0 ? (
                <p className="col-span-full text-center text-gray-500">该分类下暂无商品。</p>
              ) : (
                filteredProducts.map(product => (
                  <ProductCard key={product.id} product={product} onAdd={addToCart} />
                ))
              )}
            </div>
            {cart.length > 0 && (
              <button onClick={() => setShowCart(true)} className="fixed bottom-5 right-5 bg-red-600 text-white px-4 py-3 rounded-full shadow-lg flex items-center gap-2">
                <i className="fas fa-shopping-cart"></i>
                购物车 ({cart.reduce((sum, item) => sum + item.quantity, 0)})
              </button>
            )}
            {showCart && (
              <CartDrawer
                cart={cart}
                onClose={() => setShowCart(false)}
                updateQty={updateCartQuantity}
                removeItem={removeFromCart}
                onCheckout={() => { setShowCart(false); onCheckout(); }}
              />
            )}
          </div>
        );
      };

      // 管理员后台界面（简化版）
      const AdminPanel = ({ onExit, showToast }) => {
        const [isAuthenticated, setAuthenticated] = useState(false);
        const [password, setPassword] = useState('');
        const [orders, setOrders] = useState([]);
        const [searchTerm, setSearchTerm] = useState('');
        const [isLoading, setIsLoading] = useState(true);
        // 运输凭证模态框状态
        const [shippingModalOrder, setShippingModalOrder] = useState(null);
        const [shippingFile, setShippingFile] = useState(null);
        const [isUploadingShipping, setIsUploadingShipping] = useState(false);
        // 读取订单列表
        const fetchOrders = useCallback(async () => {
          setIsLoading(true);
          try {
            const { data, error } = await supabaseClient.from('orders').select('*').order('created_at', { ascending: false });
            if (error) {
              showToast('加载后台数据失败: ' + error.message, 'danger');
            } else {
              setOrders(data || []);
            }
          } catch (e) {
            showToast('加载后台数据失败: ' + e.message, 'danger');
          }
          setIsLoading(false);
        }, [showToast]);
        // 登录后加载数据
        useEffect(() => {
          if (isAuthenticated) {
            fetchOrders();
          }
        }, [isAuthenticated, fetchOrders]);
        // 登录验证
        const handleLogin = (e) => {
          e.preventDefault();
          if (password === ADMIN_PASSWORD) {
            setAuthenticated(true);
            showToast('登录成功', 'success');
          } else {
            showToast('管理员密码错误', 'danger');
            setPassword('');
          }
        };
        // 改变订单状态
        const handleStatusChange = async (orderId, newStatus) => {
          try {
            const { error } = await supabaseClient.from('orders').update({ status: newStatus }).eq('id', orderId);
            if (error) {
              showToast('状态更新失败: ' + error.message, 'danger');
            } else {
              showToast('订单状态已更新', 'success');
              fetchOrders();
            }
          } catch (e) {
            showToast('状态更新失败: ' + e.message, 'danger');
          }
        };
        // 打开上传运费凭证模态框
        const openShippingModal = (order) => {
          setShippingModalOrder(order);
          setShippingFile(null);
        };
        const closeShippingModal = () => {
          setShippingModalOrder(null);
          setShippingFile(null);
        };
        const handleShippingFileChange = (e) => {
          setShippingFile(e.target.files[0]);
        };
        const uploadShippingProof = async () => {
          if (!shippingFile || !shippingModalOrder) return;
          setIsUploadingShipping(true);
          try {
            const ext = shippingFile.name.split('.').pop();
            const filename = `proofs/${shippingModalOrder.order_id}-shipping.${ext}`;
            const { error: uploadError } = await supabaseClient.storage.from('payment-proofs').upload(filename, shippingFile);
            if (uploadError && !uploadError.message.includes('already exists')) {
              showToast('运费凭证上传失败: ' + uploadError.message, 'danger');
              setIsUploadingShipping(false);
              return;
            }
            const { data } = supabaseClient.storage.from('payment-proofs').getPublicUrl(filename);
            const url = data.publicUrl;
            const { error: updErr } = await supabaseClient.from('orders').update({ shipping_proof_url: url }).eq('order_id', shippingModalOrder.order_id);
            if (updErr) {
              showToast('订单更新失败: ' + updErr.message, 'danger');
            } else {
              showToast('运费支付成功，感谢您的付款！', 'success');
              fetchOrders();
              closeShippingModal();
            }
          } catch (err) {
            showToast('上传失败: ' + err.message, 'danger');
          }
          setIsUploadingShipping(false);
        };
        // 发送运费通知
        const sendShippingWhatsapp = (order) => {
          // 如果是自取订单，则无需发送运费消息
          if (order.delivery_method === 'self-pickup') {
            showToast('自取订单无需支付运费', 'warning');
            return;
          }
          const items = order.order_items || [];
          const totalItems = Array.isArray(items) ? items.reduce((sum, it) => sum + (it.quantity || 0), 0) : 0;
          const shippingFee = totalItems * 5;
          // 支付链接应该指向当前页面的域名，如果在文件系统运行则不提供有效链接
          const origin = window.location.origin.startsWith('file') ? '' : window.location.origin;
          const paymentLink = `${origin}?order_id=${order.order_id}`;
          const msg =
            `📦 *锋味派订单 #${order.order_id}*\n\n` +
            `亲爱的${order.name}，您的订单已准备发货。\n` +
            '请支付运费以完成配送。\n' +
            `订单号: ${order.order_id}\n` +
            `收件人: ${order.name}\n` +
            `联系电话: ${order.phone}\n` +
            `配送方式: ${order.delivery_method === 'self-pickup' ? '自取' : 'Lalamove送货'}\n` +
            `运费: RM${shippingFee.toFixed(2)} (RM5/件, 共${totalItems}件)\n` +
            (paymentLink ? `支付链接: ${paymentLink}\n` : '') +
            '如已支付请忽略此消息，谢谢！';
          const phone = order.phone.startsWith('60') ? order.phone : '60' + order.phone.replace(/^0/, '');
          const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
          window.open(url, '_blank');
        };
        // 复制订单详情
        const copyOrder = async (order) => {
          const msg = buildOrderMessage(order).replace(/\*/g, '');
          const ok = await copyTextUniversal(msg);
          if (ok) {
            showToast('订单详情已复制到剪贴板', 'success');
          }
        };
        // 根据搜索过滤订单
        const filteredOrders = useMemo(() => {
          const term = searchTerm.trim();
          if (!term) return orders;
          return orders.filter(o => String(o.order_id).includes(term));
        }, [orders, searchTerm]);
        // 未登录时显示登录界面
        if (!isAuthenticated) {
          return (
            <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
              <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
                <h2 className="text-2xl font-bold text-center mb-6 text-gray-800">管理员登录</h2>
                <form onSubmit={handleLogin} className="space-y-4">
                  <input
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="请输入管理员密码"
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500"
                    autoFocus
                  />
                  <button type="submit" className="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors shadow-md">
                    登录
                  </button>
                  <button type="button" onClick={onExit} className="w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                    返回商店
                  </button>
                </form>
              </div>
            </div>
          );
        }
        // 管理员界面
        return (
          <div className="min-h-screen bg-gray-100 p-4">
            <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
              <h1 className="text-3xl font-bold text-gray-800">管理后台</h1>
              <button onClick={onExit} className="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                返回商店
              </button>
            </header>
            <div className="mb-4">
              <label className="font-semibold mr-2">搜索订单号:</label>
              <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="p-2 border border-gray-300 rounded" placeholder="输入订单号搜索" />
            </div>
            {isLoading ? (
              <div className="flex justify-center p-10"><LoadingSpinner /></div>
            ) : (
              <div className="bg-white rounded-lg shadow-md p-4 overflow-x-auto">
                {filteredOrders.length === 0 ? (
                  <p className="text-center text-gray-500">暂无订单</p>
                ) : (
                  <table className="min-w-full divide-y divide-gray-200 text-sm">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">订单号</th>
                        <th className="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">客户</th>
                        <th className="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">电话</th>
                        <th className="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">取货方式</th>
                        <th className="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">状态</th>
                        <th className="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">总金额</th>
                        <th className="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">操作</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {filteredOrders.map(order => (
                        <tr key={order.id}>
                          <td className="px-4 py-2 whitespace-nowrap font-medium">{order.order_id}</td>
                          <td className="px-4 py-2 whitespace-nowrap">{order.name}</td>
                          <td className="px-4 py-2 whitespace-nowrap">{order.phone}</td>
                          <td className="px-4 py-2 whitespace-nowrap">{order.delivery_method === 'self-pickup' ? '自取' : 'Lalamove送货'}</td>
                          <td className="px-4 py-2 whitespace-nowrap">
                            <select value={order.status || 'pending'} onChange={(e) => handleStatusChange(order.id, e.target.value)} className={`px-2 py-1 rounded ${getStatusStyle(order.status)}`}>
                              {Object.keys(statusOptions).map(key => (
                                <option key={key} value={key}>{statusOptions[key].label}</option>
                              ))}
                            </select>
                          </td>
                          <td className="px-4 py-2 whitespace-nowrap text-red-600 font-bold">RM{parseFloat(order.total_amount).toFixed(2)}</td>
                          <td className="px-4 py-2 whitespace-nowrap">
                            <div className="flex flex-wrap gap-2">
                              {/* 订单付款凭证查看 */}
                              {order.payment_proof_url && (
                                <a
                                  href={order.payment_proof_url}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200"
                                >
                                  查看付款凭证
                                </a>
                              )}
                              {/* 运费凭证查看 */}
                              {order.shipping_proof_url && (
                                <a
                                  href={order.shipping_proof_url}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200"
                                >
                                  查看运费凭证
                                </a>
                              )}
                              {/* 如果是配送订单才显示运费相关功能 */}
                              {order.delivery_method !== 'self-pickup' && (
                                <>
                                  <button
                                    onClick={() => openShippingModal(order)}
                                    className="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200"
                                  >
                                    上传运费凭证
                                  </button>
                                  <button
                                    onClick={() => sendShippingWhatsapp(order)}
                                    className="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700 hover:bg-green-200"
                                  >
                                    发送运费通知
                                  </button>
                                </>
                              )}
                              <button
                                onClick={() => copyOrder(order)}
                                className="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-700 hover:bg-yellow-200"
                              >
                                复制信息
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                )}
              </div>
            )}
            {shippingModalOrder && (
              <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
                  <div className="p-4 border-b flex justify-between items-center">
                    <h3 className="text-lg font-bold">上传运费凭证</h3>
                    <button onClick={closeShippingModal} className="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                  </div>
                  <div className="p-4">
                    <input type="file" onChange={handleShippingFileChange} accept="image/*,.pdf" className="w-full p-2 border border-gray-300 rounded" />
                  </div>
                  <div className="p-4 border-t flex justify-end">
                    <button onClick={uploadShippingProof} disabled={isUploadingShipping || !shippingFile} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-300">
                      {isUploadingShipping ? '上传中...' : '上传'}
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      };

      // 主应用组件
      function App() {
        const [view, setView] = useState('customer');
        const [products, setProducts] = useState([]);
        const [cart, setCart] = useState([]);
        const [isLoading, setIsLoading] = useState(true);
        const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
        const [lastOrder, setLastOrder] = useState(null);
        const [showCheckoutModal, setShowCheckoutModal] = useState(false);
        // 显示通知
        const showToastMessage = (message, type = 'success') => {
          setToast({ show: true, message, type });
        };
        // 获取商品列表
        const fetchProducts = useCallback(async () => {
          setIsLoading(true);
          try {
            const { data, error } = await supabaseClient.from('products').select('*').order('id');
            if (error) {
              showToastMessage('加载商品失败: ' + error.message, 'danger');
            } else {
              const formatted = (data || []).map(p => {
                let imgUrl = '';
                if (p.image_url) {
                  imgUrl = p.image_url;
                } else if (p.image) {
                  const rawName = String(p.image).trim();
                  imgUrl = rawName.startsWith('http') ? rawName : (PRODUCT_IMAGE_BASE_URL + encodeURIComponent(rawName));
                }
                return {
                  ...p,
                  image: imgUrl,
                  price: Number(p.price) || 0,
                  stock: p.is_unlimited ? Infinity : (p.stock_quantity ?? 0),
                  is_unlimited: !!p.is_unlimited,
                  emoji: p.emoji || '',
                  category: p.category || '其他'
                };
              });
              setProducts(formatted);
            }
          } catch (e) {
            showToastMessage('加载商品失败: ' + e.message, 'danger');
          }
          setIsLoading(false);
        }, []);
        // 初始化加载商品
        useEffect(() => {
          fetchProducts();
        }, [fetchProducts]);
        // 添加商品到购物车
        const addToCart = (product) => {
          setCart(prev => {
            const existing = prev.find(item => item.id === product.id);
            if (existing) {
              if (product.is_unlimited || existing.quantity < product.stock) {
                showToastMessage(`${product.name} 已添加到购物车`, 'success');
                return prev.map(item => item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item);
              } else {
                showToastMessage(`${product.name} 库存不足`, 'warning');
                return prev;
              }
            }
            showToastMessage(`${product.name} 已添加到购物车`, 'success');
            return [...prev, { ...product, quantity: 1 }];
          });
        };
        // 更新购物车数量
        const updateCartQuantity = (id, qty) => {
          setCart(prev => prev.map(item => {
            if (item.id === id) {
              if (qty <= 0) {
                return null;
              }
              if (!item.is_unlimited && qty > item.stock) {
                showToastMessage(`库存不足，最多可购买 ${item.stock} 件`, 'warning');
                return { ...item, quantity: item.stock };
              }
              return { ...item, quantity: qty };
            }
            return item;
          }).filter(Boolean));
        };
        // 从购物车删除
        const removeFromCart = (id) => {
          setCart(prev => prev.filter(item => item.id !== id));
        };
        // 购物车总金额
        const cartTotal = useMemo(() => {
          return cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        }, [cart]);
        // 处理结账按钮点击
        const handleCheckout = () => {
          setShowCheckoutModal(true);
        };
        // 处理订单提交
        const handleOrderConfirm = async (formData, paymentProof, isShippingPayment) => {
          if (isShippingPayment) {
            // 运费支付：更新已有订单
            let orderId = null;
            try {
              const params = new URLSearchParams(window.location.search);
              orderId = params.get('order_id');
            } catch (e) {
              // ignore
            }
            if (!orderId) {
              showToastMessage('订单编号不存在', 'danger');
              return;
            }
            let proofUrl = null;
            if (paymentProof) {
              try {
                const ext = paymentProof.name.split('.').pop();
                const filename = `proofs/${orderId}-shipping.${ext}`;
                const { error: uploadError } = await supabaseClient.storage.from('payment-proofs').upload(filename, paymentProof);
                if (uploadError && !uploadError.message.includes('already exists')) {
                  showToastMessage('支付凭证上传失败: ' + uploadError.message, 'danger');
                  return;
                }
                const { data } = supabaseClient.storage.from('payment-proofs').getPublicUrl(filename);
                proofUrl = data.publicUrl;
              } catch (e) {
                showToastMessage('支付凭证上传失败: ' + e.message, 'danger');
                return;
              }
            }
            try {
              const { error: updErr } = await supabaseClient.from('orders').update({ shipping_payment_proof_url: proofUrl, shipping_remarks: formData.remarks }).eq('order_id', orderId);
              if (updErr) {
                showToastMessage('订单更新失败: ' + updErr.message, 'danger');
              } else {
                showToastMessage('支付凭证已上传，感谢您的付款！', 'success');
              }
            } catch (e) {
              showToastMessage('订单更新失败: ' + e.message, 'danger');
            }
            setShowCheckoutModal(false);
            return;
          }
          // 新订单
          const orderId = 'FW' + Date.now();
          let proofUrl = null;
          if (paymentProof) {
            try {
              const ext = paymentProof.name.split('.').pop();
              const filename = `proofs/${orderId}.${ext}`;
              const { error: uploadError } = await supabaseClient.storage.from('payment-proofs').upload(filename, paymentProof);
              if (uploadError && !uploadError.message.includes('already exists')) {
                showToastMessage('支付凭证上传失败: ' + uploadError.message, 'danger');
                return;
              }
              const { data } = supabaseClient.storage.from('payment-proofs').getPublicUrl(filename);
              proofUrl = data.publicUrl;
            } catch (e) {
              showToastMessage('支付凭证上传失败: ' + e.message, 'danger');
              return;
            }
          }
          // 构建订单数据
          const orderData = {
            order_id: orderId,
            name: formData.name,
            phone: formData.phone,
            delivery_method: formData.delivery,
            payment_method: formData.paymentMethod,
            address: formData.delivery === 'lalamove' ? formData.address : null,
            remarks: formData.remarks,
            total_amount: cartTotal,
            status: 'pending',
            created_at: new Date().toISOString(),
            payment_proof_url: proofUrl,
            order_items: cart.map(item => ({
              id: item.id,
              product: item.name,
              quantity: item.quantity,
              price: item.price,
              emoji: item.emoji,
              is_unlimited: item.is_unlimited
            }))
          };
          try {
            const { data, error } = await supabaseClient.from('orders').insert([orderData]).select().single();
            if (error) {
              showToastMessage('下单失败: ' + error.message, 'danger');
            } else {
              showToastMessage('下单成功，请继续 WhatsApp 确认！', 'success');
              setLastOrder(orderData);
              setCart([]);
            }
          } catch (e) {
            showToastMessage('下单失败: ' + e.message, 'danger');
          }
          setShowCheckoutModal(false);
        };
        // 新订单完成后重置
        const handleNewOrder = () => {
          setLastOrder(null);
          setCart([]);
        };
        return (
          <div>
            {toast.show && (
              <div className="fixed top-5 right-5 z-50">
                <Toast message={toast.message} type={toast.type} onDismiss={() => setToast({ show: false, message: '', type: 'success' })} />
              </div>
            )}
            {view === 'customer' && (
              <>
                {isLoading ? (
                  <div className="flex justify-center py-20"><LoadingSpinner text="加载商品中..." /></div>
                ) : (
                  <CustomerView
                    products={products}
                    cart={cart}
                    addToCart={addToCart}
                    updateCartQuantity={updateCartQuantity}
                    removeFromCart={removeFromCart}
                    cartTotal={cartTotal}
                    showToast={showToastMessage}
                    refreshProducts={fetchProducts}
                    setLastOrder={setLastOrder}
                    onAdminClick={() => setView('admin')}
                    onCheckout={handleCheckout}
                  />
                )}
              </>
            )}
            {view === 'admin' && (
              <AdminPanel onExit={() => setView('customer')} showToast={showToastMessage} />
            )}
            {showCheckoutModal && (
              <CheckoutModal cart={cart} total={cartTotal} onClose={() => setShowCheckoutModal(false)} onConfirm={handleOrderConfirm} />
            )}
            {lastOrder && (
              <OrderSuccessModal order={lastOrder} onNewOrder={handleNewOrder} />
            )}
          </div>
        );
      }

      // 渲染应用
      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
